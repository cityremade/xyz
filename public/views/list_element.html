<!doctype html>
<html lang="{{language}}">

<head data-dir="{{dir}}" data-login="{{login}}">
    <title>MAPP | User Administration</title>
    <link rel="icon" type="image/x-icon" href="{{dir}}/public/icons/favicon.ico">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.6.1/dist/ol.js" integrity="sha384-R02sHnzL8yl/uvLZvMsfgBOMBIOOHLpuLNo4dLuWQWFun1sxEWJej+SPwiGxaeGd" crossorigin="anonymous"></script>
    <!-- Load XYZ / MAPP stylesheet and library. -->
    <!--<link rel="stylesheet" href="{{dir}}/public/css/mapp.css" /> not needed here -->
    <link rel="stylesheet" href="{{dir}}/public/css/ui.css" />
    <script type="module" src="{{dir}}/public/js/lib/mapp.js" defer></script>
    <script type="module" src="{{dir}}/public/js/lib/ui.js" defer></script>
    <script type="module" src="{{dir}}/public/js/tests/_mapp.test.js" defer></script>
    <style>

      body {
        width: 100%;
        height: 100%;
        position: absolute;

        &::-webkit-scrollbar {
          display: none;
        }
      }


      /* inside viewport */
      .viewport {
        width: 100%;
        height: 100%;
        background-color: var(--color-base);

        /* outer container for roles ui */
        .roles-management {
          display:flex; 
          flex-direction: column; 
          width: 100%; 
          height: 100%;

          /* header for the split section */
          .split-screen-header {
            padding: 1em;
            margin: 1em;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-gap: 1em;

            header {
              grid-column: 1 / span 2;
              border-bottom: solid 1px var(--color-border);
            }
          }

          /* end header for the split section */

          /* begin role assignment specific layout */
          .role-assignment {
            max-height: 600px;
            padding: 1em;
            margin: 1em;
            border: solid 1px var(--color-border);
            border-radius: 10px;
            display: grid;
            grid-gap: 1em;
            grid-template-columns: repeat(2, 1fr);

            .role-hierarchy {
              /* for the role hierarchy target */
              overflow-y: auto;
            }

            .role-preview {
              overflow-y: auto;
              ul.preview-list {
                li {
                  border-bottom: solid 1px var(--color-border);
                  padding: 1em 0.5em;
                  font-family: monospace;
                }
              }
            }

            /* indent on nested lists */
            ul {
              padding-left: 0; 

              ul {
                padding-left: 2em;
              }

              button.material-symbols-outlined.disabled {
                color: var(--color-font-mid);
                cursor: default;
              }  
            }

            .inline-flex {
              display: inline-flex;
              border-bottom: solid 1px var(--color-border);
              padding: 0.2em;
              width: 100%;

              &.granted {
                background-color: rgb(from var(--color-info) r g b / 0.1);
                border-radius: 3px;
              }
            }

            .expandable {
              
              button.material-symbols-outlined.caret::after {
                content: 'arrow_right';
                color: var(--color-font);
              }

              & > div > label {
                font-weight: bold;
              }

              & ul {
                /* list closed */
                opacity: 0;
                max-height: 0;
                visibility: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
              }

              &.expanded {

                & > div > button.material-symbols-outlined.caret::after {
                  content: 'arrow_drop_down';
                  color: var(--color-font);
                }

                & > ul {
                  /* list open */
                  opacity: 1;
                  max-height: unset;
                  height: auto;
                  visibility: visible;
                  transition: max-height 0.3s ease, opacity 0.3s ease;
                }
              }
            }
          }
          /* end role assignment specific layout */
        }
      }

      /* end viewport rule */

      /* rules for mobile */
      @media only screen and (max-width: 700px) {
        body {
          margin: 0;
        }
        .desktop-only {
          display: none !important;
        }
      }

    </style>

  <body>
    <div class="viewport"></div>
    <script type="module">
        console.log(`MAPP v${mapp.version}`);
        /* Set the maxWidth for mobile responsive display. */
        mapp.utils.mobile(765);

        mapp.host = document.head.dataset.dir;

        // creates document fragment to embed ui
        const container = mapp.utils.html`<div class="roles-management">
          <div class="split-screen-header">
          <header><h1>Role Assignment</h1></header>
          <h2>Role Hierarchy</h2>
          <h2>Assigned Roles Summary</h2>
        </div>
        <div class="role-assignment">
          <div class="role-hierarchy"></div>
          <div class="role-preview"></div>
        </div></div>`;

        mapp.utils.render(document.querySelector('.viewport'), container);

         /* Get the test user from the cookie */
        const user = await mapp.utils.xhr(`${mapp.host}/api/user/cookie`);

        const tree = await mapp.utils.xhr(`${mapp.host}/api/workspace/roles?tree=true`);

        console.log(tree);

        const listDOM = listHierarchy(tree, user);

        /* create list content */
        mapp.utils.render(document.querySelector('.role-hierarchy'), mapp.utils.html.node`<div>${listDOM}`);
        /* create preview windown content */
        mapp.utils.render(document.querySelector('.role-preview'), rolePreview(user));


        /* draws role preview section content */
        function rolePreview(user) {
          const items = [];
          for(const role of user.roles) {
            items.push(mapp.utils.html`<li>${role}</li>`)
          }

          return mapp.utils.html`<ul class="preview-list">${items}`;
        }


        /* creates the list hierarchy DOM */
        function listHierarchy(obj, user) {
          const ul = mapp.utils.html.node`<ul class="main-list">`;
          // Use Object.entries to get [key, value] pairs
          for (const [key, value] of Object.entries(obj)) {
            // Check if the value is an object with inner content
            if (typeof value === 'object' && Object.keys(value).length > 0) {
              // recurse into that object
              const sublist = listHierarchy(value, user);
              ul.append(listItem({ value: key, content: sublist, user }));
            } else {
              // "leaf" value
              const li = listItem({ value: key, user });
              ul.append(li);
            }
          }

          return ul;
        }

        /* creates role item; params: user, content, value */
        function listItem(params) {

          const value = params.value;
          const content = params.content;

          const roleSet = new Set();

          for(const role of params.user.roles) {
            role.split('.').map(item => roleSet.add(item));
          }

          const checked = roleSet.has(params.value);

          const chkbox = mapp.ui.elements.chkbox({ 
            label: value, 
            val: value,
            onchange: async (state, val)=> {

              chkbox.closest('div').classList.toggle('granted');

              await role_change({
                user: params.user, 
                element: chkbox, 
                role: value, 
                checked: state 
              });
            },
            checked
          });

          if(!content) {
            return mapp.utils.html.node`<li data-id=${value}>
            <div class="${'inline-flex' + (checked ? ` granted` : ``) }">
            <button class="disabled material-symbols-outlined notranslate">shield_person</button>
            ${chkbox}`;
          }

          const li = mapp.utils.html.node`<li class="expandable" data-id=${value}>
          <div class="${'inline-flex' + (checked ? ` granted` : ``) }">
          <button class="material-symbols-outlined notranslate caret" onclick=${(e) => {
            li.classList.toggle('expanded');
          }}></button>
          ${chkbox}
          </div>
          ${content}`;

          return li;

        }

        /* runs inside checkbox change event, updates role; params: user, element, value, checked */
        async function role_change(params) {

          const element = params.element;
          const role = params.role;
          const checked = params.checked;
          const user = params.user;

          // add current role
          const role_list = [role];

          // current list item
          const current_li = element.closest('li');

          // upper list item
          let upper_li = current_li.closest('ul').closest('li');

          // from each list item up to level of main-list
          while (upper_li && !upper_li.classList.contains('main-list')) {
            // get data id which is information on role
            role_list.unshift(upper_li.dataset.id)
            // reassign upper list item
            upper_li = upper_li.closest('ul').closest('li');
          }

          // this constructs the role
          const changed_role = role_list.join('.');

          if(checked) {
            // add this to array
            user.roles.push(changed_role);
          } else {
            // filter out everything that contains this role
            user.roles = user.roles.filter(role => {
              return !role.includes(changed_role);
            })
          }

          // update with final contatenated role
          await update_user({
            user
          });

        }

        /* makes updates to user; params: user */
        async function update_user(params) {
          
          await updateUser({
            email: params.user.email,
            roles: params.user.roles
          });

          /* update hierarchy DOM based on the new roles */
          updateListDOM(params.user, listDOM);

        }
        
        /* updates hierarchy DOM after change; user and document fragment to update */
        /* handled separately from creation to prevent lists from closing by default */
        function updateListDOM(user, document_fragment) {
          const roleSet = new Set();

          // get a set of unique roles
          for(const role of user.roles) {
            role.split('.').map(item => roleSet.add(item));
          }

          // get all list items
          const all_items = document_fragment.querySelectorAll('li');

          // set state and classes where needed - granted class and checked checkbox
          for(const li of all_items) {
            li.querySelector('input').checked = roleSet.has(li.dataset.id);
            roleSet.has(li.dataset.id) ? li.querySelector('div').classList.add('granted') : li.querySelector('div').classList.remove('granted');
          }

          // redraw the preview section
          mapp.utils.render(document.querySelector('.role-preview'), rolePreview(user));

        }

        /* updates field for user entry; params: user.email and user.roles as request body */
        async function updateUser(params) {
          await fetch(`${mapp.host}/api/user/update`, {
            method: "POST",
            body: JSON.stringify(params),
            headers: {
              "Content-type": "application/json",
            },
          });
        }




</script>
</body>
</head>